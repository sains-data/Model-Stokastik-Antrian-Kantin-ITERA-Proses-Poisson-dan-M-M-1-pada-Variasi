---
title: "TUGAS BESAR PEMSTOK"
author: "KELOMPOK 14"
date: "2025-11-20"
output: html_document
---

# TUGAS BESAR PEMODELAN STOKASTIK

## Model Stokastik Antrian Kantin ITERA

```{r}
library(tidyverse)

# Data hasil observasi (sudah kamu buat)
df <- tribble(
  ~Tanggal, ~Slot_Waktu, ~Jumlah, ~Kondisi,
  "2025-11-11","11.50 - 11.55",6,"Tidak Hujan",
  "2025-11-11","11.55 - 12.00",7,"Tidak Hujan",
  "2025-11-11","12.00 - 12.05",12,"Tidak Hujan",
  "2025-11-11","12.05 - 12.10",14,"Tidak Hujan",
  "2025-11-11","12.10 - 12.15",8,"Tidak Hujan",
  "2025-11-11","12.15 - 12.20",9,"Tidak Hujan",
  "2025-11-11","12.20 - 12.25",9,"Tidak Hujan",
  "2025-11-11","12.25 - 12.30",7,"Tidak Hujan",
  "2025-11-11","12.30 - 12.35",13,"Tidak Hujan",
  "2025-11-11","12.35 - 12.40",11,"Tidak Hujan",
  "2025-11-11","12.40 - 12.45",9,"Tidak Hujan",
  "2025-11-11","12.45 - 12.50",7,"Tidak Hujan",
  "2025-11-12","11.50 - 11.55",10,"Tidak Hujan",
  "2025-11-12","11.55 - 12.00",11,"Tidak Hujan",
  "2025-11-12","12.00 - 12.05",12,"Tidak Hujan",
  "2025-11-12","12.05 - 12.10",12,"Tidak Hujan",
  "2025-11-12","12.10 - 12.15",11,"Tidak Hujan",
  "2025-11-12","12.15 - 12.20",13,"Tidak Hujan",
  "2025-11-12","12.20 - 12.25",5,"Tidak Hujan",
  "2025-11-12","12.25 - 12.30",5,"Tidak Hujan",
  "2025-11-12","12.30 - 12.35",9,"Tidak Hujan",
  "2025-11-12","12.35 - 12.40",7,"Tidak Hujan",
  "2025-11-12","12.40 - 12.45",9,"Tidak Hujan",
  "2025-11-12","12.45 - 12.50",11,"Tidak Hujan",
  "2025-11-13","11.50 - 11.55",6,"Tidak Hujan",
  "2025-11-13","11.55 - 12.00",8,"Tidak Hujan",
  "2025-11-13","12.00 - 12.05",12,"Tidak Hujan",
  "2025-11-13","12.05 - 12.10",13,"Tidak Hujan",
  "2025-11-13","12.10 - 12.15",8,"Tidak Hujan",
  "2025-11-13","12.15 - 12.20",9,"Tidak Hujan",
  "2025-11-13","12.20 - 12.25",13,"Tidak Hujan",
  "2025-11-13","12.25 - 12.30",12,"Tidak Hujan",
  "2025-11-13","12.30 - 12.35",14,"Tidak Hujan",
  "2025-11-13","12.35 - 12.40",13,"Tidak Hujan",
  "2025-11-13","12.40 - 12.45",14,"Tidak Hujan",
  "2025-11-13","12.45 - 12.50",12,"Tidak Hujan",
  "2025-11-19","11.50 - 11.55",8,"Tidak Hujan",
  "2025-11-19","11.55 - 12.00",8,"Tidak Hujan",
  "2025-11-19","12.00 - 12.05",4,"Tidak Hujan",
  "2025-11-19","12.05 - 12.10",7,"Tidak Hujan",
  "2025-11-19","12.10 - 12.15",16,"Tidak Hujan",
  "2025-11-19","12.15 - 12.20",11,"Tidak Hujan",
  "2025-11-19","12.20 - 12.25",12,"Tidak Hujan",
  "2025-11-19","12.25 - 12.30",12,"Tidak Hujan",
  "2025-11-19","12.30 - 12.35",7,"Tidak Hujan",
  "2025-11-19","12.35 - 12.40",13,"Tidak Hujan",
  "2025-11-19","12.40 - 12.45",14,"Tidak Hujan",
  "2025-11-19","12.45 - 12.50",3,"Tidak Hujan",
  "2025-11-18","11.50 - 11.55",15,"Hujan",
  "2025-11-18","11.55 - 12.00",4,"Hujan",
  "2025-11-18","12.00 - 12.05",3,"Hujan",
  "2025-11-18","12.05 - 12.10",2,"Hujan",
  "2025-11-18","12.10 - 12.15",2,"Hujan",
  "2025-11-18","12.15 - 12.20",8,"Hujan",
  "2025-11-18","12.20 - 12.25",15,"Hujan",
  "2025-11-18","12.25 - 12.30",12,"Hujan",
  "2025-11-18","12.30 - 12.35",7,"Hujan",
  "2025-11-18","12.35 - 12.40",6,"Hujan",
  "2025-11-18","12.40 - 12.45",7,"Hujan",
  "2025-11-18","12.45 - 12.50",2,"Hujan"
)
```

Penjelasan singkat: memuat data observasi asli ke dalam R menggunakan `tribble` agar formatnya rapi dan minim error.

## 1. Preprocessing: tanggal, slot jadi numerik, dan ringkasan harian

```{r}
df_clean <- df %>%
  mutate(
    Tanggal = as.Date(Tanggal),                 # ubah ke Date
    slot_id = row_number(),                     # index urut (opsional)
    slot_index = rep(1:12, times = nrow(df) / 12)  # 12 slot per hari
  )

# Ringkasan total per hari dan kondisi
daily_summary <- df_clean %>%
  group_by(Tanggal, Kondisi) %>%
  summarise(
    total = sum(Jumlah),
    .groups = "drop"
  )

daily_summary

```

## 2. Estimasi laju kedatangan λ per hari dan per kondisi (Poisson Process)

```{r}
# Asumsi jendela observasi = 1 jam (12 slot x 5 menit)
daily_lambda <- daily_summary %>%
  mutate(
    lambda_per_hour = total / 1     # pelanggan per jam
  )

daily_lambda

# Rata-rata λ per kondisi cuaca
lambda_by_cond <- daily_lambda %>%
  group_by(Kondisi) %>%
  summarise(
    lambda_mean = mean(lambda_per_hour),
    lambda_sd   = sd(lambda_per_hour),
    .groups = "drop"
  )

lambda_by_cond
```

## 3. Cek “kepoissonan” data slot 5 menit (mean vs varians)

```{r}
# Cek mean dan varians jumlah pelanggan per slot (5 menit) per kondisi
slot_stats <- df_clean %>%
  group_by(Kondisi) %>%
  summarise(
    mean_slot   = mean(Jumlah),
    var_slot    = var(Jumlah),
    ratio_var_mean = var(Jumlah) / mean(Jumlah),
    .groups = "drop"
  )

slot_stats

```

## 4. Poisson Non-Homogen (NHPP) via λ(t) per slot waktu

Di sini kita lihat bahwa λ berubah sepanjang jam (baru sangat stokastik):

```{r}
slot_lambda <- df_clean %>%
  group_by(slot_index, Kondisi) %>%
  summarise(
    rata_slot = mean(Jumlah),
    .groups = "drop"
  )

slot_lambda
```

Visualisasinya:

```{r}
ggplot(slot_lambda, aes(x = slot_index, y = rata_slot, color = Kondisi)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  scale_x_continuous(breaks = 1:12) +
  labs(
    title = "Profil Intensitas Kedatangan per Slot (λ(t))",
    x = "Slot ke- (5 menit)",
    y = "Rata-rata pelanggan per slot"
  ) +
  theme_minimal()

```

## 5. Menghitung rasio penurunan λ akibat hujan (Elasticity)

```{r}
lambda_normal <- lambda_by_cond$lambda_mean[lambda_by_cond$Kondisi == "Tidak Hujan"]
lambda_hujan  <- lambda_by_cond$lambda_mean[lambda_by_cond$Kondisi == "Hujan"]

elasticity <- (lambda_hujan - lambda_normal) / lambda_normal
elasticity

```

## 6. Model M/M/1 (Birth–Death Process) berdasarkan λ hasil observasi

Sekarang kita pakai materi **proses kelahiran-kematian / M/M/1**.

```{r}
# Fungsi metrik M/M/1 (versi tanpa stop, kasih flag stabil)
mm1_metrics <- function(lambda, mu) {
  stabil <- lambda < mu
  
  if (!stabil) {
    return(
      tibble(
        lambda = lambda,
        mu     = mu,
        rho    = NA_real_,
        L      = NA_real_,
        Lq     = NA_real_,
        W      = NA_real_,
        Wq     = NA_real_,
        stabil = FALSE
      )
    )
  }
  
  rho <- lambda / mu
  L   <- rho / (1 - rho)
  Lq  <- rho^2 / (1 - rho)
  W   <- 1 / (mu - lambda)
  Wq  <- rho / (mu - lambda)
  
  tibble(
    lambda = lambda,
    mu     = mu,
    rho    = rho,
    L      = L,
    Lq     = Lq,
    W      = W,
    Wq     = Wq,
    stabil = TRUE
  )
}

# Asumsi service rate satu kasir (μ) ~ 30 pelanggan/jam (≈ 2 menit per transaksi)
mu_kasir <- 30

mm1_normal <- mm1_metrics(lambda_normal, mu_kasir) %>%
  mutate(Kondisi = "Tidak Hujan")

mm1_hujan <- mm1_metrics(lambda_hujan, mu_kasir) %>%
  mutate(Kondisi = "Hujan")

mm1_compare <- bind_rows(mm1_normal, mm1_hujan) %>%
  mutate(
    W_min  = W  * 60,
    Wq_min = Wq * 60
  ) %>%
  select(Kondisi, stabil, everything())

mm1_compare

```

## 7. Analisis sensitivitas kebijakan: berapa μ yang dibutuhkan agar Wq ≤ target

```{r}
target_Wq_min <- 5
target_Wq_hour <- target_Wq_min / 60

mu_grid <- tibble(mu = seq(20, 200, by = 1)) %>%
  rowwise() %>%
  mutate(
    lambda = lambda_normal,
    rho    = lambda / mu,
    Wq     = ifelse(lambda < mu, rho / (mu - lambda), Inf),
    Wq_min = Wq * 60
  ) %>%
  ungroup()

mu_needed <- mu_grid %>%
  filter(Wq_min <= target_Wq_min) %>%
  slice(1)

mu_needed

```

## 8. Visualisasi kebijakan: Wq vs μ (kapasitas layanan)

```{r}
ggplot(mu_grid, aes(x = mu, y = Wq_min)) +
  geom_line(linewidth = 1) +
  geom_hline(yintercept = target_Wq_min, linetype = "dashed", color = "red") +
  labs(
    title = "Kurva Waktu Tunggu (Wq) vs Kapasitas Pelayanan μ\nKondisi Tidak Hujan",
    x = "μ (pelanggan per jam)",
    y = "Wq (menit)"
  ) +
  theme_minimal()
```
